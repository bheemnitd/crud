<!-- item-form.html -->
<div class="container" [attr.aria-busy]="loading">
  <!-- Loading Overlay -->
  <div *ngIf="loading" class="loading-overlay">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <!-- Page Header -->
  <h1 class="h3 mb-4">{{ item?.id ? 'Edit Contact' : 'Create New Contact' }}</h1>

  <!-- Alert Messages -->
  <div *ngIf="error" class="alert alert-danger" role="alert">
    <i class="bi bi-exclamation-triangle-fill me-2"></i>{{ error }}
  </div>

  <div *ngIf="success" class="alert alert-success" role="alert">
    <i class="bi bi-check-circle-fill me-2"></i>
    {{ item?.id ? 'Contact updated successfully!' : 'Contact created successfully!' }}
  </div>

  <!-- Main Form -->
  <form #contactForm="ngForm" (ngSubmit)="save()" class="form-container" novalidate>
    <div class="row g-3">
      <div class="col-md-6">
        <div class="form-group">
          <label for="first_name" class="form-label">First Name <span class="text-danger">*</span></label>
          <input id="first_name" name="first_name" [(ngModel)]="item.first_name" class="form-control"
            [class.is-invalid]="formDirty && !item.first_name" placeholder="Enter first name" required
            (input)="markFormDirty()">
          <div *ngIf="formDirty && !item.first_name" class="invalid-feedback">
            First name is required
          </div>
        </div>
      </div>

      <div class="col-md-6">
        <div class="form-group">
          <label for="last_name" class="form-label">Last Name</label>
          <input id="last_name" name="last_name" [(ngModel)]="item.last_name" class="form-control"
            placeholder="Enter last name" (input)="markFormDirty()">
        </div>
      </div>

      <div class="col-md-6">
        <div class="form-group">
          <label for="email" class="form-label">Email</label>
          <input id="email" name="email" type="email" [(ngModel)]="item.email" class="form-control"
            [class.is-invalid]="formDirty && item.email && !isValidEmail(item.email)" placeholder="Enter email"
            (input)="markFormDirty()">
          <div *ngIf="formDirty && item.email && !isValidEmail(item.email)" class="invalid-feedback">
            Please enter a valid email address
          </div>
        </div>
      </div>

      <div class="col-md-6">
        <div class="form-group">
          <label for="mobile" class="form-label">Mobile</label>
          <input id="mobile" name="mobile" type="tel" [(ngModel)]="item.mobile" class="form-control"
            placeholder="Enter mobile number" (input)="markFormDirty()">
        </div>
      </div>

      <div class="col-12">
        <div class="form-group">
          <label class="form-label">Event Notification</label>
          <div class="radio-group">
            <div class="form-check form-check-inline">
              <input type="radio" id="notifyAll" [value]="'all'" name="event_notification"
                [(ngModel)]="item.event_notification" (ngModelChange)="onNotificationModeChange('all')"
                class="form-check-input">
              <label for="notifyAll" class="form-check-label">All Users</label>
            </div>
            <div class="form-check form-check-inline">
              <input type="radio" id="notifySelected" [value]="'selected'" name="event_notification"
                [(ngModel)]="item.event_notification" (ngModelChange)="onNotificationModeChange('selected')"
                class="form-check-input">
              <label for="notifySelected" class="form-check-label">Selected Groups</label>
            </div>
          </div>
        </div>
      </div>

      <div *ngIf="item.event_notification === 'selected'" class="col-12">
        <div class="form-group">
          <label class="form-label">Select Groups</label>
          <div class="multi-select-wrapper">
            <div class="multi-select-input form-control" [class.focused]="inputFocused" (click)="focusInput()" tabindex="0">
              <ng-container *ngIf="selectedGroups.length > 0; else emptyState">
                <span class="selected-tag" *ngFor="let group of selectedGroups">
                  {{ group.name }}
                  <button type="button" class="remove-tag" (click)="removeGroup(group.id); $event.stopPropagation()">
                    &times;
                  </button>
                </span>
              </ng-container>
              <ng-template #emptyState>
                <span class="placeholder">Type to search or add groups...</span>
              </ng-template>
              <input #groupInput type="text" [(ngModel)]="groupSearch" [ngModelOptions]="{standalone: true}"
                (input)="filterGroups()" (focus)="onGroupInputFocus()" (blur)="onGroupInputBlur()"
                (keydown.enter)="onEnterKey($event)" (keydown.backspace)="onBackspace()" class="group-search-input">
            </div>

            <div class="dropdown-menu" [class.show]="showDropdown">
              <a href="javascript:void(0)" class="dropdown-item" *ngFor="let group of filteredGroups"
                (mousedown)="selectGroup(group); $event.preventDefault()">
                {{ group.name }}
                <span *ngIf="group.isNew" class="badge bg-success ms-2">New</span>
              </a>
              <div class="dropdown-item text-muted" *ngIf="groupSearch && filteredGroups.length === 0">
                Press Enter to create "{{ groupSearch }}"
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12">
        <div class="form-group">
          <label class="form-label">Available Events</label>
          <div class="event-types-container">
            <div *ngFor="let option of eventTypeOptions" class="form-check form-check-inline me-3">
              <input type="checkbox" [id]="'event-' + option.id" [name]="'event-type-' + option.id"
                [(ngModel)]="option.selected" (ngModelChange)="onEventTypeChange(option.id, $event)"
                class="form-check-input">
              <label [for]="'event-' + option.id" class="form-check-label">
                {{ option.label }}
              </label>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12">
        <div class="form-group">
          <label class="form-label d-block mb-2">Contact Status</label>
          <div class="status-options">
            <div class="form-check form-check-inline">
              <input type="radio" class="form-check-input" id="statusActive" [value]="true" name="status"
                [(ngModel)]="item.is_active" (ngModelChange)="item.is_active = $event; markFormDirty()">
              <label class="form-check-label" for="statusActive">Active</label>
            </div>
            <div class="form-check form-check-inline">
              <input type="radio" class="form-check-input" id="statusInactive" [value]="false" name="status"
                [(ngModel)]="item.is_active" (ngModelChange)="item.is_active = $event; markFormDirty()">
              <label class="form-check-label" for="statusInactive">Inactive</label>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Form Actions -->
    <div class="form-actions">
      <button type="submit" class="btn btn-primary px-4" [disabled]="saving || !formDirty">
        <span *ngIf="saving" class="spinner-border spinner-border-sm me-2" role="status"></span>
        {{ saving ? 'Saving...' : 'Save Changes' }}
      </button>
      <button type="button" class="btn btn-outline-secondary px-4" (click)="onCancel()">
        Cancel
      </button>
    </div>
  </form>
</div>