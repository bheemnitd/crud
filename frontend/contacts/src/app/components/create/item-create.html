<div class="form-container">
  <h3>Create New Contact</h3>
  <div *ngIf="formError" class="alert alert-danger">{{ formError }}</div>
  <div *ngIf="successMessage" class="alert alert-success">{{ successMessage }}</div>

  <form #contactForm="ngForm" (ngSubmit)="saveNewContact(contactForm)" novalidate>
    <!-- First Name -->
    <div class="form-group mb-3">
      <label class="form-label">First Name <span class="text-danger">*</span></label>
      <input type="text" 
             class="form-control"
             [(ngModel)]="newItem.first_name" 
             name="first_name" 
             required 
             #firstName="ngModel"
             [class.is-invalid]="firstName.invalid && (firstName.dirty || contactForm.submitted)">
      <div *ngIf="firstName.invalid && (firstName.dirty || contactForm.submitted)" class="invalid-feedback">
        First name is required
      </div>
    </div>

    <!-- Last Name -->
    <div class="form-group mb-3">
      <label class="form-label">Last Name <span class="text-danger">*</span></label>
      <input type="text" 
             class="form-control"
             [(ngModel)]="newItem.last_name" 
             name="last_name" 
             required>
    </div>

    <!-- Email -->
    <div class="form-group mb-3">
      <label class="form-label">Email <span class="text-danger">*</span></label>
      <input type="email" 
             class="form-control"
             [(ngModel)]="newItem.email" 
             name="email" 
             required
             email>
    </div>

    <!-- Mobile -->
    <div class="form-group mb-3">
      <label class="form-label">Mobile</label>
      <div class="d-flex gap-2">
        <select [(ngModel)]="selectedCountryCode" 
                name="countryCode" 
                class="form-select" 
                style="width: auto;"
                (change)="updateMobileNumber()">
          <option *ngFor="let country of countries" [value]="country.dial_code">
            {{ country.name }} ({{ country.dial_code }})
          </option>
        </select>
        <input type="tel" 
               class="form-control"
               [(ngModel)]="mobileNumber" 
               name="mobileNumber" 
               placeholder="Enter mobile number"
               (input)="updateMobileNumber()">
      </div>
    </div>

    <!-- Event Notification -->
    <div class="form-group mb-3">
      <label class="form-label">Event Notification</label>
      <div class="d-flex gap-4">
        <div class="form-check">
          <input type="radio"
                 class="form-check-input"
                 name="event_notification"         
                 value="all"
                 [(ngModel)]="newItem.event_notification"
                 (ngModelChange)="onNotificationModeChange('all')"
                 id="notifyAll">
          <label class="form-check-label" for="notifyAll">
            All Organizational App Users
          </label>
        </div>

        <div class="form-check">
          <input type="radio"
                 class="form-check-input"
                 name="event_notification"           
                 value="selected"
                 [(ngModel)]="newItem.event_notification"
                 (ngModelChange)="onNotificationModeChange('selected')"
                 id="notifySelected">
          <label class="form-check-label" for="notifySelected">
            Selection Notification Group
          </label>
        </div>
      </div>

      <!-- Selected Groups + Dropdown -->
      <div *ngIf="newItem.event_notification === 'selected'" class="mt-3 ms-3">
        <div class="selected-groups mb-2" *ngIf="selectedGroups.length > 0">
          <span class="badge bg-primary me-2 mb-2 d-inline-flex align-items-center"
                *ngFor="let group of selectedGroups; trackBy: trackByGroupId">
            {{ group.name }}
            <button type="button" 
                    class="btn-close btn-close-white ms-2" 
                    (click)="$event.stopPropagation(); removeGroup(group.id)"
                    aria-label="Remove"></button>
          </span>
        </div>

        <div class="position-relative">
          <input type="text"
                 class="form-control"
                 [(ngModel)]="groupSearch"
                 [ngModelOptions]="{standalone: true}"
                 (input)="filterGroups()"
                 (keyup.enter)="onEnterKey($event)"
                 (focus)="filterGroups()"
                 placeholder="Search and select groups..."
                 [disabled]="loadingGroups">

          <div class="dropdown-menu w-100 show"
               *ngIf="filteredGroups.length > 0"
               style="display: block; position: static; margin-top: 0.5rem; max-height: 200px; overflow-y: auto;">
            <a class="dropdown-item d-flex justify-content-between align-items-center"
               *ngFor="let group of filteredGroups"
               (click)="selectGroup(group); $event.preventDefault()"
               href="#"
               [class.active]="hoveredGroup === group.id"
               (mouseover)="hoveredGroup = group.id"
               (mouseout)="hoveredGroup = null">
              {{ group.name }}
              <span *ngIf="group.isNew" class="badge bg-info">New</span>
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- Event Types -->
    <div class="form-group mb-3">
      <label class="form-label">Event Types</label>
      <div class="d-flex flex-wrap gap-3">
        <div class="form-check" *ngFor="let event of ['Sos', '911', 'Timer', 'Safewalk']">
          <input type="checkbox"
                 class="form-check-input"
                 [id]="'event-' + event"
                 [value]="event"
                 [checked]="newItem.eventTypesArray?.includes(event)"
                 (change)="updateEventTypes(event, $event.target.checked)">
          <label class="form-check-label" [for]="'event-' + event">
            {{ event }}
          </label>
        </div>
      </div>
    </div>

    <!-- Status -->
    <div class="form-group mb-4">
      <label class="form-label">Status</label>
      <div class="d-flex gap-4">
        <div class="form-check">
          <input type="radio"
                 class="form-check-input"
                 name="is_active"          
                 [value]="true"
                 [(ngModel)]="newItem.is_active"
                 id="statusActive">
          <label class="form-check-label" for="statusActive">Active</label>
        </div>
        <div class="form-check">
          <input type="radio"
                 class="form-check-input"
                 name="is_active"           
                 [value]="false"
                 [(ngModel)]="newItem.is_active"
                 id="statusInactive">
          <label class="form-check-label" for="statusInactive">Inactive</label>
        </div>
      </div>
    </div>

    <!-- Form Actions -->
    <div class="d-flex gap-2">
      <button type="submit" 
              class="btn btn-primary"
              [disabled]="formSaving || contactForm.invalid">
        <span *ngIf="formSaving" class="spinner-border spinner-border-sm me-2"></span>
        {{ formSaving ? 'Saving...' : 'Save' }}
      </button>
      <button type="button" 
              class="btn btn-outline-secondary"
              (click)="cancelNewContact()"
              [disabled]="formSaving">
        Cancel
      </button>
    </div>
  </form>
</div>